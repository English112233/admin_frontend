require("./notifierArrow.css");
import $ from 'jquery';
import notifierAlter from 'bluesdk-notifier-alter';

function NotifierArrow() {

    let self = this;


    self.showError = function (errorStr, el) {
        if (el === undefined) {
            self.alert(errorStr);
            return;
        }
        if (typeof el === 'string') {
            el = $('#' + el);
        }
        if (!el || !el.is(":visible")) {//元素不存在或者不可见
            self.alert(errorStr);
            return;
        }

        let top = el.position().top + parseInt(el.css('margin-top'));
        let left = el.position().left + el.width() - 30;
        self.hide(el);
        let errorDivId = self.getErrorDivId(el.attr("id"));
        let html = '<div class="formError _bluesdk_notifier" id="' + errorDivId + '" style="opacity: 0.87; position: absolute; top: ' + top + 'px; left: ' + left + 'px; margin-top: -34px;"><div class="formErrorContent">' + errorStr + '<br></div><div class="formErrorArrow"><div class="line10"><!-- --></div><div class="line9"><!-- --></div><div class="line8"><!-- --></div><div class="line7"><!-- --></div><div class="line6"><!-- --></div><div class="line5"><!-- --></div><div class="line4"><!-- --></div><div class="line3"><!-- --></div><div class="line2"><!-- --></div><div class="line1"><!-- --></div></div></div>';
        el.before(html);
        let errorEl = $('#' + errorDivId);
        errorEl.css({'margin-top': '-' + errorEl.height() + 'px'});
    };


    self.getErrorDivId = function (id) {
        return id + '_validateError';
    };

    /**
     * 重新计算位置
     */
    self.reset = function () {
        $('.formError').each(function () {
            let id = $(this).attr('id').replace(/_validateError$/, '');
            let el = $('#' + id);
            let top = el.position().top + parseInt(el.css('margin-top'));
            let left = el.position().left + el.width() - 30;
            $(this).css({top: top, left: left});
        });
    };

    self.init = function () {
        $(document).on('click', '.formError', function () {
            $(this).remove();
        });
        $(window).resize(function () {
            self.reset();
        });
    };


    self.alert = function (msg) {
        notifierAlter.error(msg);
    };

    self.init();


    /************************开放方法************************/

    self.error = function (error, el) {
        if (typeof error === 'string') {
            self.showError(error, el);
        } else {
            for (let s in error) {
                if (error.hasOwnProperty(s)) {
                    self.showError(error[s], el);
                }
            }
        }
    };

    self.info = function (msg) {
        notifierAlter.info(msg);
    };

    self.success = function (msg) {
        notifierAlter.success(msg);
    };

    self.loading = function (msg, timeout) {
        notifierAlter.loading(msg, timeout);
    };

    self.hide = function (el) {
        let e = $('#' + self.getErrorDivId(el.attr('id')));
        if (e && e.length > 0) {
            e.remove();
        }
        notifierAlter.hide();
    };

    self.clear = function () {
        let e = $('.formError');
        if (e && e.length > 0) {
            e.remove();
        }
        notifierAlter.clear();
    };
}

export default new NotifierArrow();

