<template>
    <div class="mt20 info-all-wrap">
        <el-form method="post" :action="$getReqUrl(action)" onsubmit="return false;" id="merchantForm"
                 label-width="2.00rem">
            <el-collapse v-model="collapseActiveNames">

                <!--基本信息-->
                <el-collapse-item title="基本信息" name="basicInfo">
                    <slot name="extend-company"></slot>
                    <el-form-item label="公司名称">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.companyName" name="companyName" id="companyName"
                                      placeholder="公司名称"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="商户简称">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.shortName" name="shortName" id="shortName"
                                      placeholder="商户简称"></el-input>
                        </el-col>
                    </el-form-item>

                    <!--<el-form-item label="公司注册国家/地区">-->
                    <!--<el-col :span="18">-->
                    <!--&lt;!&ndash;<country-selector @change="val => model.countryCode = val" :val="model.countryCode"&ndash;&gt;-->
                    <!--&lt;!&ndash;&gt;</country-selector>&ndash;&gt;-->
                    <!--&lt;!&ndash;<input type="hidden" name="countryCode" id="countryCode" v-model="model.countryCode">&ndash;&gt;-->
                    <!--<el-input-->
                    <!--value="CN"-->
                    <!--name="countryCode"-->
                    <!--id="countryCode"-->
                    <!--disabled>-->
                    <!--</el-input>-->
                    <!--<input type="hidden" name="countryCode" id="countryCode" value="CN">-->
                    <!--</el-col>-->
                    <!--</el-form-item>-->
                    <input type="hidden" name="countryCode" id="countryCode" value="CN">

                    <el-form-item label="经营类目">
                        <el-col :span="11">
                            <el-cascader
                                    class="regionWrap"
                                    size="large"
                                    :options="CategoryData"
                                    @change="handleCategoryChange"
                                    v-model="CategoryArr"
                            >
                            </el-cascader>
                        </el-col>
                        <input type="hidden" name="industry" id="industry" v-model="model.merchantInfo.industry">
                    </el-form-item>

                    <el-form-item label="所在区县">
                        <el-col :span="11">
                            <el-cascader
                                    class="regionWrap"
                                    size="large"
                                    :options="provincialLevelOptions"
                                    @change="handleAreaCodeChange"
                                    v-model="selectedAreaCodeArr"
                            >
                            </el-cascader>
                        </el-col>
                        <input type="hidden" name="areaCode" id="areaCode" v-model="model.merchantInfo.areaCode">
                    </el-form-item>

                    <el-form-item label="公司地址">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.companyAddress" name="companyAddress" id="companyAddress"
                                      placeholder="街道地址"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="邮政编码">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.zipCode" name="zipCode" id="zipCode"
                                      placeholder="邮政编码"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="社会统一信用代码">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.licenceNo" name="licenceNo" id="licenceNo"
                                      placeholder="此项填写营业执照号或者社会统一信用代码"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="网站地址">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.website" name="website" id="website"
                                      placeholder="此项填写业务网站地址或APP名称"></el-input>
                        </el-col>
                    </el-form-item>


                    <el-form-item label="联系人">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.linkman" name="linkman"
                                      id="linkman" placeholder="真实姓名"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="联系邮箱">
                        <el-col :span="18">
                            <el-input v-model="model.merchantInfo.email" name="email"
                                      id="email" placeholder="常用联系邮箱"></el-input>
                        </el-col>
                    </el-form-item>

                    <el-form-item label="联系电话">
                        <el-col :span="11">
                            <el-input v-model="model.merchantInfo.telephone" name="telephone"
                                      id="telephone" placeholder="联系电话"></el-input>
                        </el-col>
                    </el-form-item>


                    <el-form-item :label="businessPicLabel">
                        <el-col :span="18">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.businessPic= url"
                                    types="*.jpg;*.png" size="5MB"></upload>
                            <preview-img :src="model.merchantInfo.businessPic" class="mt10" alt="公司营业执照副本"></preview-img>
                            <input type="hidden" name="businessPic" id="businessPic" v-model="model.merchantInfo.businessPic">
                        </el-col>
                    </el-form-item>


                    <el-form-item label="开户许可证" v-show="isChina">
                        <el-col :span="11">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.accountLicensePic= url"
                                    types="*.jpg;*.png" size="5MB"></upload>
                            <preview-img :src="model.merchantInfo.accountLicensePic" class="mt10" alt="开户许可证"></preview-img>
                            <input type="hidden" name="accountLicensePic" id="accountLicensePic"
                                   v-model="model.merchantInfo.accountLicensePic">
                        </el-col>
                    </el-form-item>

                    <el-form-item label="公司门头照">
                        <el-col :span="11">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.officePic1= url"
                                    types="*.jpg;*.png" size="5MB"></upload>
                            <preview-img :src="model.merchantInfo.officePic1" class="mt10" alt="公司门头照"></preview-img>
                            <input type="hidden" name="officePic1" id="officePic1" v-model="model.merchantInfo.officePic1">
                        </el-col>
                    </el-form-item>

                    <el-form-item label="公司照片一">
                        <el-col :span="11">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.officePic2= url"
                                    types="*.jpg;*.png" size="5MB"></upload>
                            <preview-img :src="model.merchantInfo.officePic2" class="mt10" alt="公司照片一"></preview-img>
                            <input type="hidden" name="officePic2" id="officePic2" v-model="model.merchantInfo.officePic2">
                        </el-col>
                    </el-form-item>

                    <el-form-item label="公司照片二">
                        <el-col :span="11">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.officePic3= url"
                                    types="*.jpg;*.png" size="5MB"></upload>
                            <preview-img :src="model.merchantInfo.officePic3" class="mt10" alt="公司照片二"></preview-img>
                            <input type="hidden" name="officePic3" id="officePic3" v-model="model.merchantInfo.officePic3">
                        </el-col>
                    </el-form-item>

                    <el-form-item label="其它资料">
                        <el-col :span="18">
                            <upload class="el-button el-button--info is-plain"
                                    :url="uploadUrl" @done="url => model.merchantInfo.extraFile= url"
                                    types="*.jpg;*.png;*.zip" size="5MB"></upload>

                            <a :href="model.merchantInfo.extraFile" v-show="model.merchantInfo.extraFile "
                               target="_blank">其它资料</a>
                            <input type="hidden" name="extraFile" id="extraFile" v-model="model.merchantInfo.extraFile">
                            <span>选填,支持jpg,png格式图片，zip压缩文件，大小不超过5MB</span>
                        </el-col>

                    </el-form-item>
                </el-collapse-item>

                <!--清算银行卡-->
                <div v-if="merchantLevel==='second'">
                    <el-collapse-item title="清算银行卡" name="bankAccount">
                        <slot name="extend-bank"></slot>
                        <el-form-item label="账户类型">
                            <el-col :span="18">
                                <template v-for="(value ,key) in BankAccountTypeEnum.map">
                                    <el-radio name="accountType" id="accountType" v-model="model.bankAccount.accountType"
                                              :label="parseInt(key)">{{value}}
                                    </el-radio>
                                </template>
                            </el-col>
                        </el-form-item>
                        <el-form-item label="账户名称">
                            <el-col :span="18">
                                <el-input v-model="model.bankAccount.accountName" name="accountName" id="accountName"
                                          placeholder="账户名称"></el-input>
                            </el-col>
                        </el-form-item>
                        <el-form-item label="银行账号">
                            <el-col :span="18">
                                <el-input v-model="model.bankAccount.accountNumber" name="accountNumber" id="accountNumber"
                                          placeholder="银行账号"></el-input>
                            </el-col>
                        </el-form-item>
                        <el-form-item label="开户银行">
                            <el-col :span="18">
                                <el-select v-model="model.bankAccount.bankNo" placeholder="开户银行" filterable>
                                    <el-option
                                            v-for="(value, key) in bankNoMap"
                                            :key="key"
                                            :label="value"
                                            :value="key">
                                    </el-option>
                                </el-select>
                                <input type="hidden" name="bankNo" id="bankNo" v-model="model.bankAccount.bankNo">
                            </el-col>
                        </el-form-item>
                        <el-form-item label="支行名称">
                            <el-col :span="18">
                                <el-input v-model="model.bankAccount.bankName" name="bankName" id="bankName"
                                          placeholder="支行名称"></el-input>
                            </el-col>
                        </el-form-item>
                    </el-collapse-item>
                </div>

                <!--修改时二级商户需要传merchantId-->
                <input v-if="merchantId" type="hidden" name="merchantId" id="merchantId" v-model="merchantId"/>

                <!--法人-->
                <div style="position:relative;">
                    <person title="法人" :model="legalPersonObj" :index="0" panelkey="legalPerson"
                            panel-name="legalPerson0"></person>
                    <!--需要传给后端的法人值-->
                    <input type="hidden" name="legalPerson" id="legalPerson"/>
                </div>
            </el-collapse>

            <!--受益人-->
            <div v-if="merchantLevel==='first'">
                <div v-for="(item,index) in ownersArr" :key="`owners${index}`" style="position:relative;">
                    <!--动态变化的panel-->
                    <el-collapse @change="collapseHandleChange(index)" v-if="hackReset" value="1">
                        <!--删除-->
                        <el-popover
                                placement="top"
                                width="160"
                                v-model="visible[`visible${index}`]">
                            <p>确定删除当前受益人？</p>
                            <div style="text-align: right; margin: 0">
                                <el-button size="mini" type="text" @click.stop="visible[`visible${index}`] = false">取消</el-button>
                                <el-button type="primary" size="mini" @click.stop="personDelete(item.staffId,index)">确定</el-button>
                            </div>
                            <el-button slot="reference" class="pdelete" type="danger" icon="el-icon-delete" circle></el-button>
                        </el-popover>

                        <!--受益人-->
                        <person title="受益人" :model="item" :index="index" panelkey="owners"
                                :panel-name="owensOpenOrHide[index]?'1':0"></person>
                    </el-collapse>
                </div>
                <!--需要传给后端的受益人值-->
                <input type="hidden" name="owners" id="owners"/>
            </div>
            <p v-if="merchantLevel==='first'" style="overflow: hidden">
                <el-col :span="24">
                    <div class="add-person-row">
                        <ul>
                            <li>添加受益人 <span class="span-tips">受益人：持股比例等于或大于25%的自然人股东（非法人）。如果需要开展跨境汇款业务，必须提供受益人信息。</span>
                            </li>
                            <li>
                                <a class="add" @click="addOwners"><span class="s-ver"></span><span class="s-hor"></span></a>
                            </li>
                        </ul>
                    </div>
                </el-col>
            </p>
            <el-form-item style="margin-top:0.20rem;">
                <el-col :span="11">
                    <el-button type="primary" @click="cancel()">取消</el-button>
                    <el-button type="primary" native-type="submit">提交</el-button>
                    <input type="hidden" class="_tip" value="保存成功！">
                    <input type="hidden" class="_loading" value="1">
                </el-col>
            </el-form-item>
        </el-form>
    </div>
</template>
<script>
    import Upload from 'bluesdk-vue-upload'
    import appConfig from './appConfig.js'
    import PreviewImg from '../../common/PreviewImg'
    import merchantUtil from '../MerchantUtil'
    import Person from './Person' // 法人受益人组件
    import bankNoMap from 'bluesdk-bank-no'

    import { regionData } from 'element-china-area-data'
    import BankAccountTypeEnum from '../../../enum/BankAccountTypeEnum'
    import CategoryDataJson from '../../../JSON/CategoryData'
    import dateUtil from 'bluesdk-date-util'

    let personDataOne = { // 法人受益人默认值
        staffId: '',
        lastName: '',
        firstName: '',
        idCardNo: '',
        expireDate: '',
        email: '',
        telephone: '',
        countryCode: 'CN',
        idPic1: '',
        idPic2: ''
    }

    let validateTerm = {
        lastName: {
            text: '姓',
            required: '请输入',
            maxLength: 50
        },
        firstName: {
            text: '名',
            required: '请输入',
            maxLength: 50
        },
        idCardNo: {
            text: '身份证号码',
            required: '请输入',
            maxLength: 40
        },
        expireDate: {
            text: '证件有效期',
            required: '请输入'
        },
        email: {
            text: '常用联系邮箱',
            required: '请输入',
            maxLength: 30
        },
        telephone: {
            text: '联系电话',
            required: '请输入',
            maxLength: 20
        },
        countryCode: {
            text: '国别代码',
            required: '请输入',
            maxLength: 30
        },
        idPic1: {
            text: '身份证正面照',
            required: '请上传'
        },
        idPic2: {
            text: '身份证反面照',
            required: '请上传'
        }
    }
    export default {
        name: 'MerchantInfoFormNew',
        data: function () {
            return {
                BankAccountTypeEnum,
                uploadUrl: appConfig.uploadUrl(),
                configData: {
                    businessScope: [],
                    country: [],
                    industry: []
                },
                bankNoMap: bankNoMap,
                visible: {},
                legalPersonObj: { ...personDataOne }, // 法人信息
                ownersArr: [], // 受益人信息,
                // panel操作
                collapseActiveNames: ['basicInfo', 'bankAccount', 'legalPerson0'],
                hackReset: true,
                owensOpenOrHide: [], // 受益人panel的显示隐藏平行数组 展开为true
                // 所在区县操作
                provincialLevelOptions: regionData, // 市区县三级级联数据
                selectedAreaCodeArr: [],
                // 经营类目
                CategoryData: CategoryDataJson, // 经营类目
                CategoryArr: [],
                PageJson: ''// 页面改变前的表单数据
            }
        },
        watch: {
            // 当表单为修改时初始化数据
            success: function (val) { // 详情数据获取成功
                if (!val) return
                this.selectedAreaCodeArr = this.recursionDistrictCounty(regionData, this.model.merchantInfo.areaCode) // 选中的市区县code集合

                let industryVal = this.model.merchantInfo.industry
                industryVal && (this.CategoryArr = [industryVal.substring(0, 3), industryVal.substring(0, 6), industryVal]) // 选中的经营类目

                // 初始化证件有效期
                let dateInitFn = function (item) {
                    if (item && item.expireDate) {
                        item.expireDate = dateUtil.format('Y-m-d', item.expireDate / 1000)
                    }
                }
                dateInitFn(this.model.legalPerson) // 初始化法人证件有效期
                this.model.owners && this.model.owners.length && this.model.owners.map((sun) => dateInitFn(sun)) // 初始受益人证件有效期

                // 页面赋值-法人数据
                this.initLegalPerson(this.model.legalPerson)

                // 页面赋值-受益人数据
                this.initOwners(this.model.owners)

                // 展开受益人
                let OA = []
                this.model.owners && this.model.owners.length > 0 && this.model.owners.map((item) => {
                    OA.push(true)
                })
                this.owensOpenOrHide = OA

                // 存储页面初始表单数据，用于判断页面是否修改
                this.setPageJson()
            }
        },
        methods: {
            // 初始化法人数据
            initLegalPerson: function (obj) {
                this.legalPersonObj = obj && obj !== {} ? obj : { ...personDataOne }
            },
            // 初始化受益人数据
            initOwners: function (arr) {
                this.ownersArr = arr && arr.length ? arr : []
            },
            /**
             *  级联组件回显，根据最后一级code找到父级code
             *  @listData 需要进行递归遍历的数据
             *  @code 最后一级的code
             * */
            recursionDistrictCounty (listData, code) {
                if (!code) {
                    return []
                }
                let selectArr = []
                let fn = function (list) {
                    for (let i = 0; i < list.length; i++) {
                        let item = list[i]
                        if (item.value === code) {
                            return true
                        } else {
                            if (item.children && item.children.length) {
                                if (fn(item.children)) {
                                    selectArr.push(item.value)
                                    return true
                                }
                            }
                        }
                    }
                }
                fn(listData) // 开始递归
                selectArr.unshift(code) // 将子级的code也追加进去
                return selectArr.reverse()
            },
            handleAreaCodeChange (value) {
                if (value && value.length && value[value.length - 1]) {
                    this.model.merchantInfo.areaCode = value[value.length - 1]
                } else {
                    this.model.merchantInfo.areaCode = ''
                }
            },
            handleCategoryChange (value) { // 经营类目
                if (value && value.length && value[value.length - 1]) {
                    this.model.merchantInfo.industry = value[value.length - 1]
                } else {
                    this.model.merchantInfo.industry = ''
                }
            },
            /**
             *  新增受益人
             * */
            addOwners () {
                this.ownersArr.push({ ...personDataOne })
                this.owensOpenOrHide.push(true)
            },
            /**
             *  删除受益人
             * */
            personDelete (id, index) {
                // console.log(id, index)
                this.visible[`visible${index}`] = false
                this.ownersArr.splice(index, 1)
                this.owensOpenOrHide.splice(index, 1)

                // 强制刷新受益人panel 解决删除后显示混乱的问题
                this.hackReset = false
                this.$nextTick(() => {
                    this.hackReset = true
                })
            },
            /**
             *  受益人展开隐藏
             * */
            collapseHandleChange (index) {
                this.owensOpenOrHide[index] = !this.owensOpenOrHide[index]
            },
            /**
             * 取消
             */
            cancel () {
                this.isShowDialog('取消', () => {
                    this.$router.go(-1)
                })
            },
            /**
             *  获取当前页面所有表单数据
             * */
            getPageObj () {
                return {
                    merchantInfo: this.model.merchantInfo,
                    bankAccount: this.model.bankAccount,
                    legalPersonObj: this.legalPersonObj,
                    ownersArr: this.ownersArr
                }
            },
            /**
             *  存储表单录入的值，用于判断页面是否修改
             * */
            setPageJson () {
                this.PageJson = JSON.stringify(this.getPageObj())
            },
            /**
             *  判断页面是否有修改
             * */
            isUpdate () {
                let currentData = this.getPageObj()
                return this.PageJson !== JSON.stringify(currentData)
            },
            /**
             *  是否显示提示页面有修改弹窗
             *  @msg 提示文本
             *  @successCallback 确认后的回调事件
             *  @cancelCallback 取消的回调事件
             * */
            isShowDialog (msg, successCallback, cancelCallback) {
                if (this.isUpdate()) { // 当前为修改页面并且页面有修改
                    this.$confirm(`当前页面有修改，是否${msg}？`, '提示', {
                        confirmButtonText: '取消并关闭',
                        cancelButtonText: '继续编辑',
                        customClass: 'common-form-Dialog'
                    }).then(() => {
                        // console.log('确定')
                        // 避免重复弹窗，更改条件判断值
                        this.setPageJson()
                        successCallback && successCallback()
                    }).catch(() => {
                        // console.log('取消')
                        cancelCallback && cancelCallback()
                    })
                } else {
                    // console.log('无修改')
                    successCallback && successCallback()
                }
            },
            /**
             *  离开页面前判断页面是否有修改,离开页面包括：路由变化、点击浏览器的回退
             *  @next 导航
             *  @to 将要跳转的页面
             * */
            beforeLeave (next, to) {
                if (this.isUpdate()) { //页面有修改
                    next(false)
                    // beforeRouteLeave后页面渲染和elementui 弹窗渲染有冲突，弹窗一闪即逝，这里加个timeout等
                    setTimeout(() => {
                        this.isShowDialog('离开', () => {
                            this.$router.push({ path: to.path, query: to.query })
                        })
                    }, 200)
                } else {
                    next(true)
                }
            }
        },
        props: {
            merchantLevel: String,
            model: Object,
            action: String,
            success: Boolean, // 数据是否获取完成
            merchantId: [String, Number],// 二级商户修改时需要传递的id
            successJumpUrl: {  // 成功提交后页面跳转的路由
                type: Object,
                default: function () {
                    return {
                        hasParams: false, // 是精确跳转到url，【默认为false 并且跳转时会自行拼接merchantId】
                        url: '' // 若hasParams为true，就指定跳转到url 否则跳转到 {name:url,query:{merchantId:merchantId}}
                    }
                }
            }
        },
        components: {
            PreviewImg,
            Upload,
            Person
        },
        mounted: function () {
            // 存储表单录入的值，用于判断页面是否修改
            this.setPageJson()
            // 表单验证注入
            let self = this
            let formValidateOption = {
                'rules': {
                    'companyName': 'required|maxLength:70',
                    'shortName': 'required|maxLength:36',
                    'countryCode': 'required',
                    'areaCode': 'required',
                    'industry': 'required',
                    'companyAddress': 'required|maxLength:140',
                    'zipCode': 'required|maxLength:16',
                    'licenceNo': 'required|maxLength:20',
                    'website': 'required|maxLength:50',
                    'linkman': 'required|maxLength:30',
                    'email': 'required|email|maxLength:50',
                    'telephone': 'required|cellphone',
                    'businessPic': 'required',
                    'officePic1': 'required',
                    'officePic2': 'required',
                    'officePic3': 'required'
                },
                scenario: self.merchantLevel, // 场景定义
                'labels': {
                    'areaCode': '所在区县',
                    'industry': '经营类目',
                    'companyName': '公司名称',
                    'companyAddress': '公司地址',
                    'linkman': '联系人',
                    'email': '常用邮箱',
                    'telephone': '常用联系电话',
                    'accountType': '账户类型 ',
                    'bankNo': '开户银行'
                },
                form: 'merchantForm',
                focus: true,
                blockMode: true,
                blur: true,
                customErrorMsg: {
                    website: {
                        required: '请输入业务网站地址或APP名称'
                    },
                    officePic1: {
                        required: '请上传公司门头照'
                    },
                    officePic2: {
                        required: '请上传公司照片'
                    },
                    officePic3: {
                        required: '请上传公司照片'
                    },
                    businessPic: {
                        required: function () {
                            return '请上传' + self.businessPicLabel
                        }
                    }
                }
            }

            if (self.merchantLevel === 'second') {  // 二级商户时才需要注入清算银行的验证
                formValidateOption.rules = {
                    ...formValidateOption.rules,
                    accountType: {
                        'second': 'required'
                    },
                    accountName: {
                        'second': 'required'
                    },
                    accountNumber: {
                        'second': 'required'
                    },
                    bankNo: {
                        'second': 'required'
                    },
                    bankName: {
                        'second': 'required'
                    }
                }
            }

            self.$formValidate(formValidateOption, {
                beforeSubmit: function (formUtil) {
                    if (self.isChina) {
                        if (!self.model.merchantInfo.accountLicensePic) {
                            formUtil.notifier.error('请上传开户许可证')
                            return false
                        }
                    }
                    /**
                     * 法人受益人验证规则
                     * @name: 法人或者受益人
                     * @str：legalPerson 或者 owners
                     * @itemObj: 验证的项
                     * */
                    let itemValidator = function (name, str, itemObj, i) {
                        for (let key in validateTerm) {
                            let thName = validateTerm[key]

                            if (key === 'expireDate' && itemObj.longTerm) { // 证件有效期选择了长期，则忽略时间选择验证
                                continue
                            }
                            formUtil.validator.removeError(`${str}${key}${i}`) // 先移除错误1--开始移除

                            // 必填验证
                            if (!formUtil.validator.innerValidators.required({
                                name: `${str}${key}${i}`,
                                data: itemObj[key],
                                errorMsg: `${thName.required}${name}${thName.text}`, // 格式如：请输入法人身份证号码
                                validator: formUtil.validator,
                                eventType: 'submit'
                            })) return true

                            // 长度验证
                            if (thName.maxLength && !formUtil.validator.innerValidators.maxLength({
                                name: `${str}${key}${i}`,
                                data: itemObj[key],
                                params: thName.maxLength,
                                errorMsg: `${name}${thName.text}长度错误，最多只能输入${thName.maxLength}个字符`,
                                validator: formUtil.validator,
                                eventType: 'submit'
                            })) return true

                            // 格式规则
                            let rule
                            if (key === 'idCardNo') {
                                rule = 'idCardNo'
                            } else if (key === 'email') {
                                rule = 'email'
                            } else if (key === 'telephone') {
                                rule = 'cellphone'
                            }
                            if (rule && !formUtil.validator.innerValidators[rule]({
                                name: `${str}${key}${i}`,
                                data: itemObj[key],
                                errorMsg: `${name}${thName.text}格式错误`,
                                validator: formUtil.validator,
                                eventType: 'submit'
                            })) return true

                            formUtil.validator.onSuccess({  // 先移除错误2--成功移除
                                name: `${str}${key}${i}`,
                                validator: formUtil.validator
                            })
                        }
                    }
                    let fn = function (name, str, listArr) {
                        for (let i = 0; i < listArr.length; i++) {
                            let itemObj = listArr[i]
                            if (itemValidator(name, str, itemObj, i)) {
                                return true
                            }
                        }
                    }

                    // 法人验证
                    if (itemValidator('法人', 'legalPerson', self.legalPersonObj, 0)) return false

                    // 受益人验证
                    if (self.merchantLevel === 'first') {
                        if (fn('受益人', 'owners', self.ownersArr)) return false
                    }
                    // 给法人和受益人赋值
                    let legalPersonDom = document.getElementById('legalPerson')
                    let ownersDom = document.getElementById('owners')
                    legalPersonDom && (legalPersonDom.value = JSON.stringify(self.legalPersonObj))
                    ownersDom && (ownersDom.value = JSON.stringify(self.ownersArr))
                    return true
                },
                success: function (result) {
                    // if (self.merchantLevel === 'first') {
                    //   self.$router.push({ 'name': 'merchantInfoView' })
                    // } else if (self.merchantLevel === 'second') {
                    //   let merchantId = result.content // 新增二级商户时会返回id
                    //   self.$router.push({
                    //     name: 'secondMerchantInfoView',
                    //     query: { merchantId: self.merchantId ? self.merchantId : merchantId }
                    //   })
                    // }
                    // 存储页面初始表单数据，用于判断页面是否修改
                    self.setPageJson()

                    if (self.successJumpUrl.hasParams) {  // 精确跳转
                        self.$router.push(self.successJumpUrl.url)
                    } else {
                        let merchantId = self.merchantId || result.content // 修改时用修改的id，没有就用新增返回的id
                        self.$router.push({
                            name: self.successJumpUrl.url,
                            query: { merchantId: merchantId }
                        })
                    }
                }
            })
        },
        computed: {
            isChina: function () {
                return merchantUtil.isChina(this.model.merchantInfo.countryCode)
            },
            businessPicLabel: function () {
                return merchantUtil.businessPicLabel(this.model.merchantInfo.countryCode)
            },
            idPic1Label: function () {
                return merchantUtil.idPic1Label(this.model.merchantInfo.countryCode)
            }
        }
    }
</script>
<style scoped>
    .regionWrap {
        width: 100%;
    }

    .pdelete {
        position: absolute;
        top: .15rem;
        right: .20rem;
        z-index: 3;
        padding: 0;
        width: .4rem;
        height: .4rem;
    }

    .add-person-row {
        width: 100%;
        color: #333;
        font-size: .14rem;
        border-radius: 0 0 .05rem .05rem;
        background: #fff;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        padding: 0 .64rem;
    }

    .add-person-row ul {
        overflow: hidden;
        list-style: none;
        width: 100%;
    }

    .add-person-row li:first-child {
        float: left;
    }

    .add-person-row li:last-child {
        float: right;
    }

    .add-person-row li {
        list-style: none;
        height: .60rem;
        line-height: .60rem;
        position: relative;
    }

    .span-tips {
        font-size: .14rem;
        color: #ff7200;
    }

    .add-person-row a {
        cursor: pointer;
        position: relative;
        display: inline-block;
        width: .20rem;
        height: .20rem;
        vertical-align: middle;
        overflow: hidden;
    }

    .add-person-row a span.s-ver {
        width: .20rem;
        height: 0;
        border-bottom: .02rem solid #227fd2;
        left: 0;
        top: .09rem;
    }

    .add-person-row a span {
        cursor: pointer;
        display: block;
        position: absolute;
    }

    .add-person-row a span.s-hor {
        width: 0;
        height: .20rem;
        border-right: .02rem solid #227fd2;
        left: .09rem;
        top: 0;
    }
</style>
