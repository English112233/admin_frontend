<!--费率新增修改表单-->
<template>
    <div>
        <el-form method="post" :action="$getReqUrl(action)" onsubmit="return false;" class="payFeeForm" id="payFeeForm"
                 label-width="100px">
            <!--二级商户ID-->
            <el-form-item :label="merchantIdLabel">
                <el-col :span="4">
                    <el-input :disabled="!isNew" v-model="info.merchantId" name="merchantId" id="merchantId"
                              :placeholder="merchantIdLabel"></el-input>
                </el-col>
            </el-form-item>

            <el-form-item label="账户类型" v-show="isAdminPlatform">
                <el-col :span="4">
                    <el-radio :disabled="!isNew" v-for="(name,value) in FeeAccountTypeEnum.map"
                              v-model="info.accountType"
                              name="accountType" :label="Number(value)" :key="value">{{name}}
                    </el-radio>
                </el-col>
            </el-form-item>

            <el-form-item label="交易类型">
                <el-col :span="18">
                    <enum-select :options="tradeTypeMap" :show-empty="false" :selected-id="info.payType"
                                 @change="val => info.payType=val" :disabled="!isNew"></enum-select>
                    <input type="hidden" name="payType" id="payType" v-model="info.payType"/>
                </el-col>
            </el-form-item>
            <el-form-item label="支付通道">
                <el-col :span="18">
                    <div v-for="item in payChannelArr" style="display: inline-block;margin-right:20px;">
                        <el-radio :disabled="!isNew" v-model="info.payChannel" name="payChannel" id="payChannel"
                                  :label="item.channelId">
                            {{item.channelName}}
                        </el-radio>
                    </div>
                </el-col>
            </el-form-item>
            <el-form-item label="费率类型">
                <el-col :span="18">
                    <template v-for="(value ,key) in PayFeeTypeEnum.map">
                        <el-radio name="feeType" id="feeType" v-model="info.feeType"
                                  :label="parseInt(key)" @change="feeTypeChange">{{value}}
                        </el-radio>
                    </template>
                </el-col>
            </el-form-item>

            <!--百分比费率 start-->
            <el-form-item label="百分比费率" v-show="info.feeType === PayFeeTypeEnum.PERCENT.value">
                <el-col :span="4">
                    <el-input v-model="info.feeRate" placeholder="百分比费率" type="number" name="feeRate"
                              id="feeRate"></el-input>
                </el-col>
                <el-col :span="4"> %</el-col>
            </el-form-item>
            <!--<input v-else type="hidden" name="feeRate" id="feeRate" v-model="info.feeRate"/>-->
            <!--百分比费率 end-->

            <!--固定费率 start-->
            <el-form-item label="固定手续费" v-show="info.feeType === PayFeeTypeEnum.FIXED.value">
                <el-col :span="4">
                    <el-input v-model="info.feeFixed" placeholder="固定手续费" type="number" name="feeFixed"
                              id="feeFixed"></el-input>
                </el-col>
                <el-col :span="4"> 元</el-col>
            </el-form-item>
            <!--<input v-else type="hidden" name="feeFixed" id="feeFixed" v-model="info.feeFixed"/>-->
            <!--固定费率 end-->

            <input v-if="info.id" type="hidden" name="id" id="id" v-model="info.id"/>

            <slot name="extend"></slot>

            <el-form-item>
                <el-col :span="11">
                    <el-button type="primary" native-type="submit">提交</el-button>
                    <input type="hidden" class="_tip" value="保存成功！">
                    <input type="hidden" class="_loading" value="1">
                </el-col>
            </el-form-item>
        </el-form>
    </div>
</template>
<script>
    import PayFeeTypeEnum from '../../enum/PayFeeTypeEnum'
    import PayTypeEnum from '../../enum/PayTypeEnum'
    import {EnumSelect} from 'bluesdk-element-common'
    import cookie from 'bluesdk-cookie'
    import BaseUtil from './BaseUtil'
    import FeeAccountTypeEnum from '../../enum/FeeAccountTypeEnum'

    export default {
        name: 'PayFeeForm',
        data () {
            return {
                FeeAccountTypeEnum,
                PayFeeTypeEnum,
                doOnce: true,// 某些平台获取支付通道只需要获取一次
                payChannelArr: [] // 支付通道
            }
        },
        computed: {
            merchantIdLabel () {
                return this.info.accountType === FeeAccountTypeEnum.AGENCY.value ? '代理商ID' : '商户ID'
            },
            isAdminPlatform () {
                return this.fromPlatform === 'admin'
            }
        },
        watch: {
            'info.payType': function (payType) {
                this.getChanel(payType)
            },
            'merchantId': function (merchantId) {
                this.getChanel(this.info.payType, merchantId)
            }
        },
        methods: {
            /**
             *  费率类型变化，清空百分比费率、固定费率
             * */
            feeTypeChange: function (value) {
                this.info.feeFixed = ''
                this.info.feeRate = ''
            },
            /**
             *  获取支付通道
             *  @payType 支付类型
             *  @merchantId 商户id 【一级】
             *  注意：任意参数发生变化，需要重新获取数据
             * */
            getChanel: function (payType, merchantId) {
                if (this.isAdminPlatform) {  // 运营后台获取支付通道
                    if (!this.doOnce) return  // 只需要获取一次充值通道的数据，因为当前获取的是所有通道
                    this.doOnce = false
                    this.$getJson({
                        url: this.actionGetChanel,
                        callback (vue, res) {
                            vue.payChannelArr = res.content.list
                            if (vue.payChannelArr.length === 0) {
                                vue.$message({
                                    type: 'error',
                                    message: '无可用充值通道。'
                                })
                            }
                            vue.info.payChannel = Number(BaseUtil.radioDefaultValue(vue.payChannelArr, 'channelId', cookie.get('payFeelChnlId')))
                        }
                    })

                } else {  // 其他平台获取支付通道
                    let url = this.actionGetChanel + '?payType=' + payType
                    merchantId && (url += '&merchantId=' + merchantId)
                    this.$getJson({
                        url: url,
                        callback (vue, res) {
                            vue.payChannelArr = res.content
                            if (vue.payChannelArr.length === 0) {
                                vue.$message({
                                    type: 'error',
                                    message: '无可用支付通道。'
                                })
                            }
                            vue.info.payChannel = Number(BaseUtil.radioDefaultValue(vue.payChannelArr, 'channelId', cookie.get('payFeelChnlId')))
                        }
                    })
                }
            }
        },
        props: {
            tradeTypeMap: {
                type: Object,
                default () {
                    return PayTypeEnum.map
                }
            },
            isNew: false,
            action: String, // 提交接口
            // 获取支付通道
            actionGetChanel: String, // 获取支付通道的接口
            merchantId: [Number, String], // 一级商户ID 商户平台不用传
            successJumpUrl: String, // 成功提交后页面跳转的地址
            // 所有修改字段
            info: Object,
            fromPlatform: String // admin:运营后台，merchant:商户平台 ，agency:代理商平台 【目前就运营后台和其他平台有出入 区别：1.在支付通道获取上。2.提交成功的页面跳转上】
        },
        components: {EnumSelect},
        beforeMount: function () {
            // 新增时 交易类型 默认选择第一项
            if (!this.info.payType && this.isNew) {
                for (let x in this.tradeTypeMap) {
                    this.info.payType = x
                    break
                }
            }
        },
        mounted: function () {
            let self = this
            let formValidateOption = {
                'rules': {
                    'merchantId': 'required|maxLength:70',
                    'payType': 'required',
                    'feeType': 'required',
                    'feeRate': {
                        'isRate': 'required|numeric|decimal:2|minNumeric:0'
                    },
                    'feeFixed': {
                        'isFix': 'required|numeric|decimal:2|minNumeric:0'
                    }
                },
                scenario: function () {
                    return self.info.feeType === PayFeeTypeEnum.PERCENT.value ? 'isRate' : 'isFix'
                },
                labels: {
                    'feeRate': '百分比费率',
                    'feeFixed': '固定费率'
                },
                form: 'payFeeForm',
                focus: true,
                blockMode: true,
                blur: true,
                customErrorMsg: {
                    payType: {
                        required: '请选择交易类型'
                    }
                }
            }
            self.$formValidate(formValidateOption, {
                beforeSubmit: function (formUtil) {
                    if (!self.info.payChannel) {
                        formUtil.notifier.error('请选择支付通道')
                        return false
                    }
                    return true
                },
                success: function (result) {
                    cookie.set('payFeelChnlId', self.info.payChannel)
                    let hrefObj = {}
                    if (self.isAdminPlatform) { // 运营后台跳转到所有列表
                        hrefObj = {
                            name: self.successJumpUrl
                        }
                    } else { // 成功跳转到筛选为merchantId的列表
                        hrefObj = {
                            name: self.successJumpUrl,
                            query: {merchantId: self.info.merchantId}
                        }
                    }
                    self.successJumpUrl && self.$router.push(hrefObj)
                },
                converter (item) {
                    if (item.value) {
                        if (item.name === 'feeRate') {  // 百分比费率除以100
                            return item.value / 100
                        } else if (item.name === 'feeFixed') {
                            return item.value * 100
                        }
                    }
                    return item.value
                }
            })
        }
    }
</script>
